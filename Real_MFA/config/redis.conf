# Redis Configuration for Real_MFA (Cache + Celery Broker)
# Location: /etc/redis/redis.conf
# Optimized for Django with Celery

# Network & General
bind 127.0.0.1
port 6379
timeout 0
tcp-backlog 511
tcp-keepalive 300
daemonize no
pidfile /var/run/redis/redis-server.pid
loglevel notice
logfile /var/log/redis/redis-server.log
databases 16

# Snapshotting (Persistence)
# Save if 900 seconds passed and 1 key changed, etc
save 900 1
save 300 10
save 60 10000

# Don't save on shutdown for speed (Celery tasks are re-queued)
save ""

# RDB Compression & Checksum
rdbcompression yes
rdbchecksum yes
dbfilename dump.rdb
dir /var/lib/redis

# Replication
replica-read-only yes
replica-serve-stale-data yes

# Security
requirepass your_redis_password_here_123!@#
# Or use ACL (Redis 6+):
# user default on >your_redis_password_here_123!@# ~* &* +@all

# Memory Management
maxmemory 256mb
maxmemory-policy allkeys-lru  # Remove least recently used keys when full

# Client Output Buffer Limits
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# Append Only File (AOF)
appendonly no
appendfilename "appendonly.aof"
appendfsync everysec
no-appendfsync-on-rewrite no
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# Latency Monitoring
latency-monitor-threshold 0

# Event Notification
notify-keyspace-events ""

# Lazy Freeing
lazyfree-lazy-eviction no
lazyfree-lazy-expire no
lazyfree-lazy-server-del no
replica-lazy-flush no

# Active Defragmentation
activedefrag no
active-defrag-ignore-bytes 100mb
active-defrag-threshold-lower 10

# Performance Tuning for Django
hz 10
dynamic-hz yes
